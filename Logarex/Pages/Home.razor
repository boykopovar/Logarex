@page "/"
@using System.Text
@using Logarex.Models.LangParsers.PythonParser
@using Logarex.Models.LangParsers.Contracts

<PageTitle>Home</PageTitle>

<div class="page-container">

    <div class="code-panel">
        <textarea class="code-input"
                  @bind="_code"
                  placeholder="Вставьте программный код для анализа...">
        </textarea>

        <button class="analyze-button" @onclick="Analyze">
            Анализировать
        </button>
    </div>

    <div class="stats-panel">
        <div class="stats-title">Результаты анализа</div>
        <div class="stats-table-wrapper">
            <table class="stats-table">
                <thead>
                <tr>
                    <th>Метрика</th>
                    <th>Значение</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Уникальные операторы (η1)</td>
                    <td>@_uniqueOperators</td>
                </tr>
                <tr>
                    <td>Уникальные операнды (η2)</td>
                    <td>@_uniqueOperands</td>
                </tr>
                <tr>
                    <td>Всего операторов (N1)</td>
                    <td>@_totalOperators</td>
                </tr>
                <tr>
                    <td>Всего операндов (N2)</td>
                    <td>@_totalOperands</td>
                </tr>
                <tr>
                    <td>Словарь программы</td>
                    <td>@_vocabulary</td>
                </tr>
                <tr>
                    <td>Длина программы</td>
                    <td>@_length</td>
                </tr>
                <tr>
                    <td>Объем программы</td>
                    <td>@_volume</td>
                </tr>
                <tr>
                    <td>Общее количество строк</td>
                    <td>@_lineCount</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    @if (_operators.Any() || _operand.Any())
    {
        <div class="table-row">
            @if (_operators != null && _operators.Any())
            {
                <div class="stats-panel">
                    <div class="stats-title">Операторы</div>
                    <div class="stats-table-wrapper">
                        <table class="stats-table">
                            <thead>
                            <tr>
                                <th>Оператор</th>
                                <th>Количество</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var kvp in _operators.OrderBy(o => o.Key))
                            {
                                <tr>
                                    <td>@kvp.Key</td>
                                    <td>@kvp.Value</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            @if (_operand != null && _operand.Any())
            {
                <div class="stats-panel">
                    <div class="stats-title">Операнды</div>
                    <div class="stats-table-wrapper">
                        <table class="stats-table">
                            <thead>
                            <tr>
                                <th>Операнд</th>
                                <th>Количество</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var kvp in _operand.OrderBy(o => o.Key))
                            {
                                <tr>
                                    <td>@kvp.Key</td>
                                    <td>@kvp.Value</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
    @if (_highlightedCode != null)
    {
        <div class="highlighted-panel">
            <div class="stats-title">Подсвеченный код</div>
            <div class="highlighted-code">@((MarkupString)_highlightedCode)</div>
        </div>
    }
</div>

@code {

private string _code = string.Empty;

private IReadOnlyDictionary<string, int> _operators = new Dictionary<string, int>();
private IReadOnlyDictionary<string, int> _operand = new Dictionary<string, int>();

private int _uniqueOperators;
private int _uniqueOperands;
private int _totalOperators;
private int _totalOperands;
private int _vocabulary;
private int _length;
private double _volume;
private int _lineCount;
private string? _highlightedCode = null;

private void Analyze()
{
if (string.IsNullOrWhiteSpace(_code))
return;

ILangParser parser = new PythonParser();
IParseResult result = parser.Parse(_code);

_operators = result.Metrics.Operators;
_operand = result.Metrics.Operands;

_uniqueOperators = result.Metrics.UniqueOperatorsCount;
_uniqueOperands = result.Metrics.UniqueOperandsCount;
_totalOperators = result.Metrics.TotalOperatorsCount;
_totalOperands = result.Metrics.TotalOperandsCount;
_vocabulary = result.Metrics.ProgramVocabulary;
_length = result.Metrics.ProgramLength;
_volume = Math.Round(result.Metrics.ProgramVolume, 2);

_lineCount = _code.Split('\n', StringSplitOptions.RemoveEmptyEntries).Length;

_highlightedCode = BuildHighlightedCode(_code, result.Tokens);
}
private string BuildHighlightedCode(string source, List<TokenInfo> tokens)
{
    if (tokens == null || !tokens.Any())
        return System.Web.HttpUtility.HtmlEncode(source);

    var ordered = tokens.OrderBy(t => t.StartIndex).ToList();
    var sb = new StringBuilder();
    int lastPos = 0;

    foreach (var token in ordered)
    {
        if (token.StartIndex > lastPos)
        {
            string text = source.Substring(lastPos, token.StartIndex - lastPos);
            sb.Append(System.Web.HttpUtility.HtmlEncode(text));
        }

        string tokenText = System.Web.HttpUtility.HtmlEncode(token.Text);
        string cssClass = token.IsOperator ? "operator" : "operand";
        sb.Append($"<span class=\"{cssClass}\">{tokenText}</span>");

        lastPos = token.StartIndex + token.Length;
    }

    if (lastPos < source.Length)
    {
        string text = source.Substring(lastPos);
        sb.Append(System.Web.HttpUtility.HtmlEncode(text));
    }

    return sb.ToString();
}
}
